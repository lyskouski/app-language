name: Project Verification Steps

on:
  pull_request:

jobs:
  build:
    name: Create Linux Build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install requirements
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

# To Be Checked ...
      - name: Patch Kivy for Cython 3.1.x compatibility
        run: |
          KIVY_PATH=$(python -c "import kivy; import os; print(os.path.dirname(kivy.__file__))")
          sed -i 's/cdef long i = long(h \* 6.0)/cdef long i = <long>(h * 6.0)/' "$KIVY_PATH/graphics/context_instructions.pyx"
          sed -i 's/isinstance(indices, (long, int))/isinstance(indices, int)/' "$KIVY_PATH/graphics/opengl.pyx"
          sed -i 's/isinstance(data, (long, int))/isinstance(data, int)/' "$KIVY_PATH/graphics/opengl.pyx"
          sed -i '/def __long__(self):/,+1d' "$KIVY_PATH/weakproxy.pyx"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake libtool m4 \
              libffi-dev pkg-config libltdl-dev openjdk-17-jdk unzip

      - name: Compile Android package
        run: buildozer android debug

      - name: List build directory contents
        run: ls -l
        working-directory: build

      - name: Search for APK file and copy to workspace
        run: |
          echo "Searching for APK files in build directory..."
          APK_PATH=$(find build -name "*.apk" -type f | head -1)
          if [ -n "$APK_PATH" ]; then
            echo "Found APK at: $APK_PATH"
            cp "$APK_PATH" "$GITHUB_WORKSPACE/tlum_Android.apk"
          else
            echo "ERROR: No APK file found in build directory!"
            echo "Contents of build directory:"
            ls -la build/
            exit 1
          fi

      - name: Add Artifact to Build
        uses: actions/upload-artifact@v4
        with:
          name: tlum_Android
          path: tlum_Android.apk
